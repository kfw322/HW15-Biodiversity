<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Names</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
</head>
<body>
    
    <form id="myForm">
        <h2>Names</h2>
        <select id="SelName" onchange="optionChanged(this.value)">
                <option>Choose Name</option>
            </select>
        <div id= "pie"></div>
        <hr>

            <script>
                var samplenamelist;
                var hovertext = [];
                var values = [];
                var labels = [];
                var i;
                var data;
                
                function init(){
                    console.log("init");
                    data = [{
                        values: values,
                        labels: labels,
                        hovertext: hovertext,
                        type: "pie"
                    }];
                    var layout = {};
                    Plotly.plot("pie",data,layout);
                    console.log("plotted: ", data);
                }

                Plotly.d3.json("/names", function(error, samplenamelist){
                    console.log("plotly.d3.json./names");
                    for(i = 0; i < samplenamelist.length; i += 1) {
                        var $dropdown = d3.select("#SelName");
                        var $label = $dropdown.append("option").attr("value",samplenamelist[i]).text(samplenamelist[i]);
                    }
                    
                });
                init();
                    
                function optionChanged(route){
                    console.log("optionchanged");
                    console.log(route);
                    var newdata;
                    values=[];
                    labels=[];
                    hovertext=[];
                    Plotly.d3.json(`/samples/${route}`,function(error,data){
                        labels = data.map(data => data.otu_ids)[0].splice(0,10);
                        console.log("labels:",labels);
                        values = data.map(data => data.sample_values)[0].splice(0,10);
                        values = values.map(Number);
                        console.log("values:",values);

                        Plotly.d3.json(`/metadata/${route}`,function(error,data){
                            hovertext = JSON.stringify(data);
                            console.log(hovertext);

                            data = [{
                                values: values,
                                labels: labels,
                                hovertext: hovertext,
                                type: "pie"
                            }];
                            console.log(data);
                            newdata = data;
                            console.log(labels,values,hovertext);  
                            updatePlotly(labels,values,hovertext);  
                        });

                    });


                
                    function updatePlotly(labels,values,hovertext) {

                        console.log("UPDATE PLOTLY INPUT TEST LABELS: ",labels," VALUES: ", values, "hovertext: ", hovertext);
                        var PIE = document.getElementById("pie");

                        data = {
                            values: [values],
                            labels: [labels],
                            hovertext: [hovertext],
                            type: "pie"
                        };
                        Plotly.restyle(PIE, data);

                        console.log(PIE, data);

                        console.log("restyled");
                    }
                }
                
                
            </script>
        
    </form>
    
</body>
</html>
